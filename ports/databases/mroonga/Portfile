# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                mroonga
version             3.08

set version_mysql55     5.5.33
set revision_mysql55    0

set version_mysql56     5.6.13
set revision_mysql56    0

set version_mariadb     5.5.33a
set revision_mariadb    0

set version_percona     5.5.32
set release_percona     31.0
set revision_percona    0

categories-append   textproc
license             LGPL-2.1
maintainers         openmaintainer

description     Fast fulltext search on MySQL
long_description \
   Mroonga is a storage engine for MySQL. \
   It provides fast fulltext search feature to all MySQL users. \
   Mroonga was called groonga storage engine.

homepage        http://mroonga.github.io/
distname        mroonga-${version}
worksrcdir      ${distname}
distfiles       ${distname}${extract.suffix}:mroonga

master_sites    http://packages.groonga.org/source/mroonga/:mroonga

set distname_mysql55    mysql-${version_mysql55}
set distname_mysql56    mysql-${version_mysql56}
set distname_mariadb    mariadb-${version_mariadb}
set distname_percona    Percona-Server-${version_percona}-rel${release_percona}

checksums \
    ${distname}${extract.suffix} \
        rmd160  c11d79c1e6c37dfb14d2bf611f9624f6078b1d72 \
        sha256  5b5a915954bb24a08de0e6baec72a4a0367da6c93b218a20fd9d34cb627df3c2 \
    ${distname_mysql55}${extract.suffix} \
        rmd160  a2574b2ff320b0b4f93fb3a616f4ebbacd31f641 \
        sha256  6ad9af38de1f3595c5fb81bc24bdb62fa39b2ce1c690d87ac7d7a21ca71fceba \
    ${distname_mysql56}${extract.suffix} \
        rmd160  22411eda9da0d931a44ab0710ded76c065cd05e6 \
        sha256  5d1b230c3ce896fbea47a69b14b9efb122621a19f32c1102d388d8e7fa442d7e \
    ${distname_mariadb}${extract.suffix} \
        rmd160  284504f3335fb7e89e039448530b3ea6ba01effc \
        sha256  adf4d04087177fde6568082c3fee77e52e84dc3ae4eb5b994d5defaaa8c83d5b \
    ${distname_percona}${extract.suffix} \
        rmd160  7901e6f0f7312c8c226e0286ce3fa8a693a857e3 \
        sha256  e34676cea5ceb398258408e31e8527724845f83bbbf1f22308f5069304118e8f \

depends_lib     port:groonga

configure.compiler  llvm-gcc-4.2

patch.pre_args  -p0
patchfiles      patch-configure.diff

subport mysql55-mroonga {
    revision            ${revision_mysql55}
    depends_lib-append  port:mysql55
    distfiles-append    ${distname_mysql55}${extract.suffix}:mysql
    master_sites-append \
        http://cdn.mysql.com/Downloads/MySQL-5.5/:mysql \
        http://mysql.he.net/Downloads/MySQL-5.5/:mysql \
        http://mirrors.sunsite.dk/mysql/Downloads/MySQL-5.5/:mysql \
        http://sunsite.informatik.rwth-aachen.de/mysql/Downloads/MySQL-5.5/:mysql \
        http://mirror.facebook.net/mysql/Downloads/MySQL-5.5/:mysql \
        http://ftp.plusline.de/mysql/Downloads/MySQL-5.5/:mysql \
        http://mysql.mirrors.pair.com/Downloads/MySQL-5.5/:mysql

    set mysql_bindir    ${prefix}/lib/mysql55/bin

    configure.args \
        --with-mysql-source=${workpath}/${distname_mysql55} \
        --with-mysql-config=${mysql_bindir}/mysql_config

    variant doc description {Install man page and documentation} {}
    post-destroot {
        if {![variant_isset doc]} {
            delete ${destroot}${prefix}/share/doc ${destroot}${prefix}/share/man
        }
    }
}

subport mysql56-mroonga {
    revision            ${revision_mysql56}
    depends_lib-append  port:mysql56
    distfiles-append    ${distname_mysql56}${extract.suffix}:mysql
    master_sites-append \
        http://cdn.mysql.com/Downloads/MySQL-5.6/:mysql \
        http://mysql.he.net/Downloads/MySQL-5.6/:mysql \
        http://mirrors.sunsite.dk/mysql/Downloads/MySQL-5.6/:mysql \
        http://sunsite.informatik.rwth-aachen.de/mysql/Downloads/MySQL-5.6/:mysql \
        http://mirror.facebook.net/mysql/Downloads/MySQL-5.6/:mysql \
        http://ftp.plusline.de/mysql/Downloads/MySQL-5.6/:mysql \
        http://mysql.mirrors.pair.com/Downloads/MySQL-5.6/:mysql

    set mysql_bindir    ${prefix}/lib/mysql56/bin

    configure.ldflags-append    -L${prefix}/lib/mysql56/mysql
    configure.args \
        --with-mysql-source=${workpath}/${distname_mysql56} \
        --with-mysql-config=${mysql_bindir}/mysql_config

    variant doc description {Install man page and documentation} {}
    post-destroot {
        if {![variant_isset doc]} {
            delete ${destroot}${prefix}/share/doc ${destroot}${prefix}/share/man
        }
    }
}

subport mariadb-mroonga {
    revision            ${revision_mariadb}
    depends_lib-append  port:mariadb
    distfiles-append    ${distname_mariadb}${extract.suffix}:mariadb
    master_sites-append \
        http://ftp.osuosl.org/pub/mariadb/${distname_mariadb}/kvm-tarbake-jaunty-x86/:mariadb \
        http://mirror2.hs-esslingen.de/mariadb/${distname_mariadb}/kvm-tarbake-jaunty-x86/:mariadb \
        http://mirror3.layerjet.com/mariadb/${distname_mariadb}/kvm-tarbake-jaunty-x86/:mariadb \
        http://ftp.yz.yamagata-u.ac.jp/pub/dbms/mariadb/${distname_mariadb}/kvm-tarbake-jaunty-x86/:mariadb \
        http://mirrors.supportex.net/mariadb/${distname_mariadb}/kvm-tarbake-jaunty-x86/:mariadb \
        http://mirror.switch.ch/mirror/mariadb/${distname_mariadb}/kvm-tarbake-jaunty-x86/:mariadb \
        http://mirrors.fe.up.pt/pub/mariadb/${distname_mariadb}/kvm-tarbake-jaunty-x86/:mariadb \
        http://gd.tuwien.ac.at/db/mariadb/${distname_mariadb}/kvm-tarbake-jaunty-x86/:mariadb \
        http://mirror.aarnet.edu.au/pub/MariaDB/${distname_mariadb}/kvm-tarbake-jaunty-x86/:mariadb \
        http://ftp.heanet.ie/mirrors/mariadb/${distname_mariadb}/kvm-tarbake-jaunty-x86/:mariadb

    set mysql_bindir    ${prefix}/lib/mariadb/bin

    configure.args \
        --with-mysql-source=${workpath}/${distname_mariadb} \
        --with-mysql-config=${mysql_bindir}/mysql_config

    variant doc description {Install man page and documentation} {}
    post-destroot {
        if {![variant_isset doc]} {
            delete ${destroot}${prefix}/share/doc ${destroot}${prefix}/share/man
        }
    }
}

subport percona-mroonga {
    revision            ${revision_percona}
    depends_lib-append  port:percona
    distfiles-append    ${distname_percona}${extract.suffix}:percona
    master_sites-append \
        http://www.percona.com/redir/downloads/Percona-Server-5.5/Percona-Server-${version_percona}-${release_percona}/source/:percona

    set mysql_bindir    ${prefix}/lib/percona/bin

    configure.args \
        --with-mysql-source=${workpath}/${distname_percona} \
        --with-mysql-config=${mysql_bindir}/mysql_config

    variant doc description {Install man page and documentation} {}
    post-destroot {
        if {![variant_isset doc]} {
            delete ${destroot}${prefix}/share/doc ${destroot}${prefix}/share/man
        }
    }
}

if {$name == $subport} {
    configure {
        ui_warn "mroonga is a virtual port"
        return -code error "try mysql55-mroonga, mysql56-mroonga, mariadb-mroonga or percona-mroonga"
    }

    livecheck.type  regex
    livecheck.url   ${homepage}
    livecheck.regex {Mroonga ([0-9.]+) has}
} else {
    notes "
To install mroonga plugin, run the following command:
   ${mysql_bindir}/mysql -uroot -e 'INSTALL PLUGIN mroonga SONAME \"ha_mroonga.so\";'
   ${mysql_bindir}/mysql -uroot -e 'CREATE FUNCTION last_insert_grn_id RETURNS INTEGER SONAME \"ha_mroonga.so\";'
   ${mysql_bindir}/mysql -uroot -e 'CREATE FUNCTION mroonga_snippet RETURNS STRING SONAME \"ha_mroonga.so\";'
   ${mysql_bindir}/mysql -uroot -e 'CREATE FUNCTION mroonga_command RETURNS STRING SONAME \"ha_mroonga.so\";'

To confirm successfuly installed, run the following command
and confirm that 'mroonga' is in the list:

    mysql> SHOW PLUGINS;
    +---------+--------+----------------+---------------+---------+
    | Name    | Status | Type           | Library       | License |
    +---------+--------+----------------+---------------+---------+
    | ...     | ...    | ...            | ...           | ...     |
    | mroonga | ACTIVE | STORAGE ENGINE | ha_mroonga.so | GPL     |
    +---------+--------+----------------+---------------+---------+
    XX rows in set (0.00 sec)

To uninstall mroonga plugin, run the following command:
   ${mysql_bindir}/mysql -uroot -e 'DROP FUNCTION last_insert_grn_id;'
   ${mysql_bindir}/mysql -uroot -e 'DROP FUNCTION mroonga_snippet;'
   ${mysql_bindir}/mysql -uroot -e 'DROP FUNCTION mroonga_command;'
   ${mysql_bindir}/mysql -uroot -e 'UNINSTALL PLUGIN mroonga;'
"

    livecheck.type  none
}
