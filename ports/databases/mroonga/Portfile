# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                mroonga
version             4.03

set version_mysql56     5.6.19
set revision_mysql56    0

categories-append   textproc
license             LGPL-2.1
maintainers         openmaintainer

description     Fast fulltext search on MySQL
long_description \
   Mroonga is a storage engine for MySQL. \
   It provides fast fulltext search feature to all MySQL users. \
   Mroonga was called groonga storage engine.

homepage        http://mroonga.github.io/
distname        mroonga-${version}
worksrcdir      ${distname}
distfiles       ${distname}${extract.suffix}:mroonga

master_sites    http://packages.groonga.org/source/mroonga/:mroonga

set distname_mysql56    mysql-${version_mysql56}

checksums \
    ${distname}${extract.suffix} \
        rmd160  b4118e02e7ad210357264b69587fc3fe56847c35 \
        sha256  7dcfd0830864a93c00a32aab90cc5fe2297c44f7667c08ad937d7f1a7e3b35f8 \
    ${distname_mysql56}${extract.suffix} \
        rmd160  3cc8acbef87c98f5221307f9b8351bd7d2f7f7e3 \
        sha256  80ef3aae048866539380e7e330d9f1034f0ee50ddfb9c662570132492678b09f

depends_lib     port:groonga

subport mysql56-mroonga {
    revision            ${revision_mysql56}
    depends_lib-append  port:mysql56
    distfiles-append    ${distname_mysql56}${extract.suffix}:mysql
    master_sites-append mysql:MySQL-5.6:mysql

    set mysql_bindir    ${prefix}/lib/mysql56/bin

    configure.ldflags-append    -L${prefix}/lib/mysql56/mysql
    configure.args \
        --with-mysql-source=${workpath}/${distname_mysql56} \
        --with-mysql-config=${mysql_bindir}/mysql_config

    variant doc description {Install man page and documentation} {}
    post-destroot {
        if {![variant_isset doc]} {
            delete ${destroot}${prefix}/share/doc ${destroot}${prefix}/share/man
        }
    }
}

if {$name == $subport} {
    configure {
        ui_warn "mroonga is a virtual port"
        return -code error "try mysql56-mroonga"
    }

    livecheck.type  regex
    livecheck.url   ${homepage}
    livecheck.regex {Mroonga ([0-9.]+) has}
} else {
    set quoted_soname "'ha_mroonga.so'"
    notes "
To install mroonga plugin, run the following command:
   ${mysql_bindir}/mysql -uroot -e \"INSTALL PLUGIN mroonga SONAME ${quoted_soname};\"
   ${mysql_bindir}/mysql -uroot -e \"CREATE FUNCTION last_insert_grn_id RETURNS INTEGER SONAME ${quoted_soname};\"
   ${mysql_bindir}/mysql -uroot -e \"CREATE FUNCTION mroonga_snippet RETURNS STRING SONAME ${quoted_soname};\"
   ${mysql_bindir}/mysql -uroot -e \"CREATE FUNCTION mroonga_command RETURNS STRING SONAME ${quoted_soname};\"
   ${mysql_bindir}/mysql -uroot -e \"CREATE FUNCTION mroonga_escape RETURNS STRING SONAME ${quoted_soname};\"

To confirm successfuly installed, run the following command
and confirm that 'mroonga' is in the list:

    mysql> SHOW ENGINES;
    +---------+---------+---------+--------------+-----+------------+
    | Engine  | Support | Comment | Transactions | XA  | Savepoints |
    +---------+---------+---------+--------------+-----+------------+
    | ....    | ...     | ...     | ...          | ... | ...        |
    | mroonga | YES     | CJK...  | NO           | NO  | NO         |
    | ...     | ...     | ...     | ...          | ... | ...        |
    +---------+---------+---------+--------------+-----+------------+
    XX rows in set (0.00 sec)

To uninstall mroonga plugin, run the following command:
   ${mysql_bindir}/mysql -uroot -e 'DROP FUNCTION last_insert_grn_id;'
   ${mysql_bindir}/mysql -uroot -e 'DROP FUNCTION mroonga_snippet;'
   ${mysql_bindir}/mysql -uroot -e 'DROP FUNCTION mroonga_command;'
   ${mysql_bindir}/mysql -uroot -e 'DROP FUNCTION mroonga_escape;'
   ${mysql_bindir}/mysql -uroot -e 'UNINSTALL PLUGIN mroonga;'
"

    livecheck.type  none
}
